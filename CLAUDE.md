# Optex Codebase Architecture and Development Guide

## Project Overview

**Optex** is a general-purpose command option wrapper and utility for Perl. It provides a flexible system for:
- Creating option aliases for any command on the system
- Extending commands with Perl modules using the `-M` flag
- Managing command configurations through `.rc` files and TOML configuration
- Supporting symbolic links for seamless command wrapping

### Core Purpose
Optex enables users to define custom option aliases and provide module-style extensibility for any command without modifying the command itself. It's built on top of [Getopt::EX](https://metacpan.org/pod/Getopt%3A%3AEX), a sophisticated option handling framework.

### Project Metadata
- **Current Version**: 1.02 (as of 2025-03-08)
- **Author**: Kazumasa Utashiro
- **License**: Perl Artistic License
- **GitHub**: http://kaz-utashiro.github.io/optex/
- **Repository**: Using Minilla for build/release management

## Build and Test Infrastructure

### Build System
- **Builder**: Module::Build::Tiny (ModuleBuildTiny)
- **Build File**: `Build.PL` (auto-generated by Minilla)
- **Perl Requirement**: 5.008_001+
- **Platform Support**: All except MSWin32 (explicitly unsupported)

### Testing
- **Test Framework**: Test::More
- **Test Location**: `/t/` directory
- **Test Files**:
  - `t/00_compile.t` - Compilation tests
  - `t/01_run.t` - Basic execution tests using Test::More and Test::Command
  - `t/02_config.t` - Configuration and TOML parsing tests
- **Test Execution**: Using `prove` (standard Perl test runner)
- **Environment**: Tests use a mock home directory at `t/home/` with `.optex.d/` structure

### Dependencies (cpanfile)
**Runtime**:
- `Getopt::EX` >= 2.1.6 (core framework)
- `Getopt::EX::Hashed` >= 1.0503 (option definition DSL)
- `Getopt::EX::i18n` (internationalization support)
- `List::Util` >= 1.45
- `Hash::Util` (for lock_keys functionality)
- `TOML` >= 0.95 (config file parsing)
- `Text::VisualWidth::PP` >= 0.05 (visual width calculations)
- `Text::ANSI::Tabs` >= 1.04 (ANSI tab handling)
- `Time::Piece` (time formatting)
- `Text::Glob` (glob pattern matching)

**Test**:
- `Test::More` >= 0.98
- `Test::Command` >= 0.11
- `File::Spec`
- `File::Path`

### Release Management
- **Tool**: Minilla (minil.toml)
- **Module Maker**: ModuleBuildTiny
- **Release Hooks**: Runs `make -C docs` before release
- **Default Branch**: master
- **Unsupported OS**: MSWin32

## Code Architecture

### Directory Structure
```
optex/
├── script/
│   └── optex              # Main executable (943 lines, POD + code)
├── lib/
│   └── App/optex/
│       ├── optex.pm       # Package namespace declaration
│       ├── help.pm        # Help module with __DATA__ options
│       ├── debug.pm       # Debug module for introspection
│       ├── Tmpfile.pm     # Temporary file handling
│       ├── util.pm        # Utility functions (setenv, chdir) + __DATA__
│       └── util/
│           ├── argv.pm    # Argument manipulation module
│           └── filter.pm  # Input/output filter module
├── t/
│   ├── 00_compile.t
│   ├── 01_run.t
│   ├── 02_config.t
│   └── home/              # Mock home directory for tests
│       └── .optex.d/      # Test config directory
├── docs/
│   ├── README.md
│   ├── Makefile
│   └── Various translations (deepl, gpt4)
├── Build.PL               # Build configuration
├── cpanfile               # Dependency specification
├── minil.toml            # Minilla configuration
├── Changes               # Version history
├── README.md             # Main documentation
└── LICENSE               # Perl license

```

### Main Entry Point: script/optex

The main script is a comprehensive option wrapper (~943 lines) that:

1. **Initialization**
   - Decodes UTF-8 arguments
   - Loads TOML configuration from `~/.optex.d/config.toml`
   - Sets up Getopt::EX loader with base classes: `['', 'App::optex', 'Getopt::EX']`
   - Establishes module search paths

2. **Key Variables**
   - `$rcloader`: Getopt::EX::Loader instance for managing options
   - `$mod_opt`: The module flag (default: `-M`)
   - `$mod_arg`: Whether to process -M options in target command
   - `$config_dir`: `~/.optex.d/` (or `$OPTEX_ROOT`)
   - `$bin_dir`: `~/.optex.d/bin` (or `$OPTEX_BINDIR`)

3. **Core Flow**
   - Parse self options (--link, --unlink, --ls, --rc, --nop, --module, --exit)
   - Get target command name (from argv or symlink name)
   - Handle command aliases from config
   - Load command-specific RC file: `~/.optex.d/<command>.rc`
   - Configure Getopt::EX to parse `-M` options in arguments
   - Execute target command with processed arguments

4. **Key Functions**
   - `load_rc()` - Load .rc configuration files
   - `search_path()` - Find target command in PATH
   - `self_option()` - Parse optex-specific options
   - `_symlink()` - Manage symbolic links
   - `_ls()` - List available links and aliases
   - `_rc()` - List or display RC files
   - `prepend_path()` - Manage module search paths
   - `show_modules()` - Display available modules

### Module System Architecture

#### Standard Module Locations
1. **Private modules**: `~/.optex.d/` (user-specific)
2. **Command-specific modules**: `~/.optex.d/<command>/`
3. **System modules**: `App::optex` namespace in Perl library path
4. **Getopt::EX modules**: `Getopt::EX` namespace (e.g., i18n)

#### Module Loading
- Modules are loaded via `-M` flag: `-Mmodule_name`
- Modules can be invoked with parameters: `-Mutil::argv::times(count=3)`
- Module `.pm` files are normal Perl packages with `__DATA__` sections
- `__DATA__` sections contain option definitions in Getopt::EX syntax
- An `initialize($mod, $argv)` sub receives module and argv object

#### Default Module (Auto-loaded)
- `~/.optex.d/<command>/default.pm` is automatically loaded for each command
- Useful for persistent behavior without explicit `-M` option

### Standard Built-in Modules

#### 1. **help** (App::optex::help)
**Purpose**: Display available options and module documentation

**Options** (in `__DATA__`):
- `-x` - Show options without help text
- `-l` - Show module path
- `-m` - Show module content
- `-h, --man` - Show POD documentation

**Functions**:
- `usage()` - Print available options
- `perldoc()` - Execute perldoc for module documentation
- `shellquote()` - Quote shell arguments safely

#### 2. **debug** (App::optex::debug)
**Purpose**: Enable debugging output

**Features**:
- Enables Getopt::EX::Loader debug mode
- Enables optex main debug flag (`$main::debug`)
- `dump(key => 1)` function to inspect loader state
- `dump(all => 1)` to dump all available information

#### 3. **util** (App::optex::util)
**Purpose**: Common utility functions

**Functions**:
- `setenv(NAME=VALUE, ...)` - Set environment variables
- `chdir(path=/directory)` - Change working directory

**Options** (in `__DATA__`):
- `--chdir` - Module option for changing directory

#### 4. **util::argv** (App::optex::util::argv)
**Purpose**: Manipulate command arguments

**Key Functions**:
- `argv(&coderef)` - Execute code block to transform @$argv
- `times(count=N, suffix=STR)` - Duplicate arguments
- `reverse()` - Reverse argument order
- `collect(index=INDICES)` - Select arguments by index
- `collect(glob=PATTERN)` - Select arguments by glob pattern
- `collect(omit=PATTERN)` - Exclude arguments by glob pattern
- `collect(match=REGEX)` - Select arguments by regex
- `collect(unmatch=REGEX)` - Exclude arguments by regex
- `proc()` - Handle process substitution
- `filter(command=CMD)` - Apply filter command to file arguments
- `enable(move,copy,...)` - Enable pre-defined options

**Important Notes**:
- Parameters use `name=value` syntax
- Function can be called as `-Mutil::argv::function(param=value)`
- Alternative format: `-Mutil::argv::function=param=value`
- Recent change (v1.02): Changed `include/exclude` to `match/unmatch` (include/exclude still work as aliases)

#### 5. **util::filter** (App::optex::util::filter)
**Purpose**: Implement input/output filters

**Key Functions**:
- `set(STDIN=command)` - Set input filter
- `set(STDOUT=command)` - Set output filter
- `set(STDERR=command)` - Set error filter
- `set(PREFORK=command)` - Pre-fork filter
- `io_filter(&coderef, io => 1)` - Low-level filter implementation
- `visible(name=flag, ...)` - Make control chars visible
  - Supports: esc, nl, tab, space, etc.
  - Flags: '' (hide), 'c' (^X format), 's' (unicode symbol)
- `unctrl()` - Visualize control characters
- `rev_line()` - Reverse line order
- `rev_char()` - Reverse character order in lines
- `shuffle_line()` - Shuffle lines randomly
- `interval(time=N)` - Output lines at regular intervals (seconds)
- `io_color(STDOUT=COLOR, STDERR=COLOR)` - Colorize output
- `splice_line(offset=N, length=M)` - Splice lines
- `timestamp(format=STR, color=C)` - Add timestamps to lines

**Recent Change** (v1.01): Introduced `interval()` function with exportable interface

**Options** (auto-generated from functions):
- `--if COMMAND` - Input filter
- `--of COMMAND` - Output filter
- `--ef COMMAND` - Error filter
- `--isub FUNCTION` - Input filter function
- `--osub FUNCTION` - Output filter function
- `--esub FUNCTION` - Error filter function
- `--psub FUNCTION` - Pre-fork filter function
- `--set-io-color IO=COLOR` - Set color filter

### Configuration System

#### TOML Configuration (`~/.optex.d/config.toml`)
```toml
# Disable -M option processing for specific commands
no-module = [
    "echo",
    "grep",
]

# Define command aliases
[alias]
    tc = "optex -Mtextconv"
    double = "expr 2 *"
    hello = "echo 'hello world'"
```

#### RC Files
- **Default RC**: `~/.optex.d/default.rc` - Applied to all commands
- **Command RC**: `~/.optex.d/<command>.rc` - Applied to specific command
- **Format**: Getopt::EX option definition syntax
- **Examples**:
  ```
  option -I        -Idate
  option -Iseconds +%FT%T%z
  define __macro__ value
  expand variable substitution
  ```

#### Option Definition Syntax
**In .rc files or __DATA__ sections**:
```
option <name> <expansion>     # Define an option alias
define <name> <definition>    # Define a macro
expand <name> <substitution>  # Expansion (scope-limited)
autoload <options>            # Auto-load modules
```

**Special Variables**:
- `$<shift>` - Shift next argument
- `$<move>` - Move to end of arguments
- `$<move(N,M)>` - Move specific arguments

### File and Directory Locations

**Environment Variables** (override defaults):
- `OPTEX_ROOT` - Override `~/.optex.d`
- `OPTEX_CONFIG` - Override `~/.optex.d/config.toml`
- `OPTEX_MODULE_PATH` - Colon-separated module paths (prepended)
- `OPTEX_BINDIR` - Override `~/.optex.d/bin`
- `DEBUG_OPTEX` - Enable debug output (=1)

**Standard Directories**:
```
~/.optex.d/                    # Root directory
├── config.toml              # Configuration file
├── default.rc               # Common options
├── <command>.rc             # Command-specific options
├── <command>/               # Command-specific modules
│   ├── default.pm           # Auto-loaded module
│   └── other.pm            # Named modules
├── <shared>.pm              # Shared modules (any command)
└── bin/                      # Symbolic link directory
    ├── cmd1 -> optex
    ├── cmd2 -> optex
    └── ...
```

## Key Code Patterns

### 1. Module Initialization Pattern
```perl
package App::optex::util::filter;

my($mod, $argv);

sub initialize {
    ($mod, $argv) = @_;
}

# Functions here...

1;

__DATA__
option --if   &set(STDIN=$<shift>)
option --of   &set(STDOUT=$<shift>)
```

### 2. Getopt::EX Loader Configuration
```perl
require Getopt::EX::Loader;
$rcloader = Getopt::EX::Loader->new(
    BASECLASS => [ '', 'App::optex', 'Getopt::EX' ],
    IGNORE_NO_MODULE => 1,
);
$rcloader->load(FILE => "$config_dir/default.rc");
$rcloader->configure(PARSE_MODULE_OPT => $mod_arg);
$rcloader->deal_with(\@ARGV);
```

### 3. Argument Transformation Pattern (util::argv)
```perl
sub argv (&) {
    my $sub = shift;
    @$argv = $sub->(@$argv);
}

# Usage in function:
argv {
    map { process($_) } @_;
};
```

### 4. Filter Implementation Pattern (util::filter)
```perl
sub io_filter (&@) {
    my $sub = shift;
    my %opt = @_;
    my $pid = do {
        if    ($opt{STDIN})  { open STDIN,  '-|' }
        elsif ($opt{STDOUT}) { open STDOUT, '|-' }
        elsif ($opt{STDERR}) { open STDERR, '|-' }
    } // die "fork: $!\n";
    return $pid if $pid > 0;  # Parent process
    
    if ($opt{STDERR}) {
        open STDOUT, '>&', \*STDERR or die "dup: $!";
    }
    $sub->();  # Child process
    close STDOUT;
    close STDERR;
    exit 0;
}
```

### 5. __DATA__ Section for Options
```perl
__DATA__
option --chdir      -M__PACKAGE__::chdir(PATH=$<shift>)
option --vowels     __count_vowels__
```

**Substitution Variables**:
- `__PACKAGE__` - Current package name
- `$<shift>` - Shift next argument
- `$<move>` - Move specified arguments

### 6. Tmpfile Pattern (util::argv, util::filter)
```perl
use App::optex::Tmpfile;

sub filter {
    state @persist;  # Keep temp files alive
    argv {
        for (@_) {
            -e $_ or next;
            my $tmp = new App::optex::Tmpfile;
            $tmp->write(`filter_command < $_`)->rewind;
            push @persist, $tmp;
            $_ = $tmp->path;  # Replace with /dev/fd/N
        }
        @_;
    }
}
```

## Testing Patterns

### Running Tests
```bash
perl -I lib -I . -e 'use Test::More; ...'
prove -l t/
```

### Test Fixtures
- **Test Home**: `t/home/` with mock `.optex.d/`
- **Configuration**: `t/home/.optex.d/config.toml` with test aliases
- **Test Commands**: `true`, `false`, `echo` for basic testing

### Test Example (t/01_run.t)
```perl
use Test::More;
use File::Spec;

$ENV{HOME} = "$t/home";

is(optex('-Mhelp', 'true'), 0, '-Mhelp');
is(optex('-Mutil::argv', 'true'), 0, '-Mutil::argv');

sub optex {
    system($^X, "-I$lib", $bin, @_) >> 8;
}

done_testing;
```

## Recent Changes and Key Enhancements

### Version 1.02 (2025-03-08)
- Updated `-Mutil::argv` module
  - No longer requires target file to exist
  - Renamed `include/exclude` to `match/unmatch` (aliases still work)
  - Added `omit` parameter as opposite of `glob`

### Version 1.01 (2024-09-22)
- Uses `$ENV{DEBUG_OPTEX}` for debug flag
- Removed `.optex.d/bin` from PATH on startup
- Enhanced `util::argv::collect()` function
- **Introduced `interval()` function with exportable interface in `util::filter`**

### Version 1.00 (2024-08-14)
- Stable release with core features complete

## Development Patterns and Best Practices

### For Module Developers
1. Create module in `~/.optex.d/<command>/<name>.pm` or `~/.optex.d/<name>.pm`
2. Implement `initialize($mod, $argv)` sub to receive module object
3. Use `__DATA__` section to define `option` directives
4. Export functions via `@EXPORT_OK` if using Exporter pattern
5. Use `Hash::Util::lock_keys` to validate parameters

### For RC File Writers
1. Use `option` for command-specific aliases
2. Use `expand` for scope-limited definitions
3. Use `define` for macro text substitutions
4. Use special variables: `$<shift>`, `$<move>`, etc.
5. Reference modules with `-M` prefix: `-Mutil::argv::function`

### UTF-8 Handling
- All I/O is UTF-8 by default
- Arguments are decoded from UTF-8: `map { utf8::is_utf8($_) ? $_ : decode('utf8', $_) } @ARGV`
- Module file handles use `:encoding(utf8)`

### Exit Code Management
```perl
our $exit_code;

# In END block
END {
    if (defined $exit_code) {
        $? = $exit_code;
    } elsif (defined $status) {
        $? = $status >> 8;
    }
}

# Via --exit option
option --exit=<num> -M...(exit_code=<num>)
```

## Integration Points

### With Getopt::EX
- Uses `Getopt::EX::Loader` for module/rc loading
- Uses `Getopt::EX::Hashed` for option definition DSL
- Uses `Getopt::EX::Func` for function call parsing
- Inherits from `Getopt::EX` base classes
- Can load any `Getopt::EX` module (e.g., i18n)

### With System
- Executes target commands via `system()` call
- Inherits environment and file descriptors
- Manages STDIN/STDOUT/STDERR for filters
- Uses symbolic links in PATH for transparent wrapping

## Important Notes for Code Navigation

1. **Main logic** is in `/script/optex` (943 lines)
2. **Module examples** are in `/lib/App/optex/*` (good references for custom modules)
3. **Tests** use a mock home directory structure
4. **Most configuration** is TOML-based, minimal hard-coded defaults
5. **Filter architecture** uses process forking for I/O redirection
6. **The `interval()` function fix** is in `/lib/App/optex/util/filter.pm` (introduced v1.01)

## Deprecated/Changed Terminology

- `include` → `match` (in util::argv::collect)
- `exclude` → `unmatch` (in util::argv::collect)
- Old names still work as aliases for backward compatibility

## Common Use Cases

### Create Option Alias
Create `~/.optex.d/date.rc`:
```
option --iso-8601 -I$<shift>
option -Iseconds +%FT%T%z
```
Then: `optex date --iso-8601 seconds`

### Create Command Alias
In `~/.optex.d/config.toml`:
```toml
[alias]
    compare = "optex -Mtextconv diff"
```
Then: `optex --ln compare` creates symlink, use as `compare file1 file2`

### Create Default Module
Create `~/.optex.d/ls/default.pm`:
```perl
package default;
$ENV{LANG} = 'C';
1;
```
Auto-loaded for all `ls` commands through optex.

### Use Filter Pipeline
```bash
optex cat -Mutil::filter --of 'sort | uniq' myfile
```

### Transform Arguments
```bash
optex diff -Mutil::argv::filter=command='cat -n' file1 file2
```

---

**End of Architecture Guide**
